<%- include('partials/_head') %>

<link rel="stylesheet" href="/css/receita.css">
<link rel="stylesheet" href="/css/navbar.css">
<link rel="stylesheet" href="/css/footer.css">

<body>
  <!-- BOT√ÉO VOLTAR -->
  <div class="voltar-container">
    <button class="voltar" onclick="window.history.back()" aria-label="Voltar">
      <img src="/assets/setinha-cinza.svg" alt="Voltar" width="25" height="25">
    </button>
  </div>

  <!-- NAVBAR -->
  <%- include('partials/_navbar') %>

  <main class="container-receita" style="position:relative;">

    <h1 id="nome-receita"><%= recipe.title %></h1>

    <div class="imagem-central">
      <img
        id="imagem-receita"
        src="<%= recipe.cover_image || '/assets/imagem-padrao.png' %>"
        alt="<%= recipe.title %>"
      >
    </div>

    <div class="detalhes-receita">
      <a href="/perfil" aria-label="Perfil">
        <img
          id="avatar-autor"
          src="/assets/icon-perfil.svg"
          alt="Usu√°rio"
        >
      </a>

      <span id="autor-receita">
        <%= recipe.author_name || 'Autor desconhecido' %>
      </span>

      <img src="/assets/icon-tempo.svg" alt="Rel√≥gio">
      <span id="tempo-preparo">
        <%= recipe.prep_time_min || '‚Äî' %>
      </span>
    </div>

    <% 
      // ------- NORMALIZA INGREDIENTES -------
      let ingredientes = [];
      if (Array.isArray(recipe.ingredients)) {
        ingredientes = recipe.ingredients;
      } else if (typeof recipe.ingredients === 'string' && recipe.ingredients.trim()) {
        try {
          const parsed = JSON.parse(recipe.ingredients);
          if (Array.isArray(parsed)) {
            ingredientes = parsed;
          } else {
            ingredientes = [recipe.ingredients];
          }
        } catch (e) {
          ingredientes = [recipe.ingredients];
        }
      }

      // ------- NORMALIZA PASSOS -------
      let passos = [];
      if (Array.isArray(recipe.steps)) {
        passos = recipe.steps;
      } else if (typeof recipe.steps === 'string' && recipe.steps.trim()) {
        try {
          const parsedSteps = JSON.parse(recipe.steps);
          if (Array.isArray(parsedSteps)) {
            passos = parsedSteps;
          } else {
            passos = [recipe.steps];
          }
        } catch (e) {
          passos = [recipe.steps];
        }
      }
    %>

    <section class="sobre">
      <h2>Sobre a Receita</h2>
      <p id="sobre-receita"><%= recipe.description || '' %></p>
    </section>

    <section class="ingredientes">
      <h2>Ingredientes</h2>
      <ul id="ingredientes">
        <% if (ingredientes && ingredientes.length) { %>
          <% ingredientes.forEach(function(ing) { %>
            <li><%= ing %></li>
          <% }) %>
        <% } %>
      </ul>
    </section>

    <section class="preparo">
      <h2>Modo de Preparo</h2>
      <ol id="modo-preparo">
        <% if (passos && passos.length) { %>
          <% passos.forEach(function(step) { %>
            <li><%= step %></li>
          <% }) %>
        <% } %>
      </ol>
    </section>

    <section class="dica-chef">
      <h2>Dica do Chef</h2>
      <p id="dica-chef"><%= recipe.tip || '' %></p>
    </section>

    <section class="comentarios">
      <h2>Coment√°rios</h2>

      <form id="form-comentario">
        <textarea
          id="comentario-texto"
          rows="3"
          placeholder="Escreva um coment√°rio..."
          required
        ></textarea>
        <button type="submit">Enviar coment√°rio</button>
      </form>

            <ul id="lista-comentarios">
        <% 
          const listaComentarios = (typeof comments !== 'undefined' && Array.isArray(comments))
            ? comments
            : [];
        %>

        <% listaComentarios.forEach(function(c) { %>
          <li class="comentario-item"
              data-comment-id="<%= c.id %>"
              data-user-id="<%= c.user_id %>">
            
            <div class="comentario-topo">
              <div class="comentario-autor">
                <!-- üîπ NOME DE QUEM COMENTOU -->
                <strong><%= c.author_name %></strong>
              </div>
              <span class="comentario-data">
                <%= c.createdAt.toLocaleDateString('pt-BR') %>
              </span>
            </div>

            <p class="comentario-conteudo"><%= c.content %></p>

            <!-- üîπ BOT√ïES (V√ÉO APARECER S√ì PRO DONO VIA JS) -->
            <div class="comentario-acoes">
              <button type="button" class="btn-edit-comment" style="display:none;">
                Editar
              </button>
              <button type="button" class="btn-delete-comment" style="display:none;">
                Excluir
              </button>
            </div>
          </li>
        <% }) %>
      </ul>
    </section>
  </main>

  <%- include('partials/_footer') %>

  <script src="/js/categorias.js"></script>
  <script src="/js/navbar.js"></script>
  <script src="/js/receita.js" defer></script>
</body>
</html>
