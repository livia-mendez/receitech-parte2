<%- include('partials/_head') %>

<link rel="stylesheet" href="/css/receita.css">
<link rel="stylesheet" href="/css/navbar.css">
<link rel="stylesheet" href="/css/footer.css">

<body>
  <!-- BOT츾O VOLTAR -->
  <div class="voltar-container">
    <button class="voltar" onclick="window.history.back()" aria-label="Voltar">
      <img src="/assets/setinha-cinza.svg" alt="Voltar" width="25" height="25">
    </button>
  </div>

  <!-- NAVBAR -->
  <%- include('partials/_navbar') %>

  <main class="container-receita" style="position:relative;">

    <%
      // Avatar do autor
      const avatarUrl = recipe.author_avatar || '/assets/icon-perfil.svg';

    

    <span><%= formatTempo(recipe.prep_time_min) %></span>


    <h1 id="nome-receita"><%= recipe.title %></h1>

    <!-- 游댠 BLOCO DE A칂칏ES DA RECEITA (S칍 APARECE PRO AUTOR VIA JS) -->
    <div
      class="receita-acoes"
      data-recipe-id="<%= recipe.id %>"
      data-author-id="<%= recipe.user_id %>"
      style="display: none;"
    >
      <button
        type="button"
        class="btn-acao-receita btn-editar-receita"
        aria-label="Editar receita"
      >
        <img src="/assets/icon-editar.png" alt="Editar receita">
      </button>

      <button
        type="button"
        class="btn-acao-receita btn-excluir-receita"
        aria-label="Excluir receita"
      >
        <img src="/assets/icon-excluir.png" alt="Excluir receita">
      </button>
    </div>

    <!-- IMAGEM -->
    <div class="imagem-central">
      <img
        id="imagem-receita"
        src="<%= recipe.cover_image || '/assets/imagem-padrao.png' %>"
        alt="<%= recipe.title %>"
      >
    </div>

    <!-- DETALHES DO AUTOR -->
        <!-- DETALHES DO AUTOR -->
    <div class="detalhes-receita">

      <!-- LINK PARA PERFIL (JS decide se 칠 /perfil ou /usuario/:id) -->
      <a
        href="/usuario/<%= recipe.user_id %>"
        class="link-perfil-autor"
        data-author-id="<%= recipe.user_id %>"
        aria-label="Perfil do autor"
      >
        <img
          id="avatar-autor"
          src="<%= avatarUrl %>"
          alt="<%= recipe.author_name || 'Usu치rio' %>"
        >
      </a>

      <!-- NOME DO AUTOR (MESMA L칍GICA) -->
      <a
        href="/usuario/<%= recipe.user_id %>"
        class="link-nome-autor"
        data-author-id="<%= recipe.user_id %>"
        style="text-decoration:none;color:inherit;"
      >
        <span id="autor-receita">
          <%= recipe.author_name || 'Autor desconhecido' %>
        </span>
      </a>

      <img src="/assets/icon-tempo.svg" alt="Rel칩gio">
      <span id="tempo-preparo">
        <%= tempoFormatado %>
      </span>
    </div>


    <% 
      // ------- NORMALIZA INGREDIENTES -------
      let ingredientes = [];
      if (Array.isArray(recipe.ingredients)) {
        ingredientes = recipe.ingredients;
      } else if (typeof recipe.ingredients === 'string' && recipe.ingredients.trim()) {
        try {
          const parsed = JSON.parse(recipe.ingredients);
          ingredientes = Array.isArray(parsed) ? parsed : [recipe.ingredients];
        } catch (e) {
          ingredientes = [recipe.ingredients];
        }
      }

      // ------- NORMALIZA PASSOS -------
      let passos = [];
      if (Array.isArray(recipe.steps)) {
        passos = recipe.steps;
      } else if (typeof recipe.steps === 'string' && recipe.steps.trim()) {
        try {
          const parsedSteps = JSON.parse(recipe.steps);
          passos = Array.isArray(parsedSteps) ? parsedSteps : [recipe.steps];
        } catch (e) {
          passos = [recipe.steps];
        }
      }
    %>

    <!-- SOBRE -->
    <section class="sobre">
      <h2>Sobre a Receita</h2>
      <p id="sobre-receita"><%= recipe.description || '' %></p>
    </section>

    <!-- INGREDIENTES -->
    <section class="ingredientes">
      <h2>Ingredientes</h2>
      <ul id="ingredientes">
        <% if (ingredientes.length) { %>
          <% ingredientes.forEach(function(ing) { %>
            <li><%= ing %></li>
          <% }) %>
        <% } %>
      </ul>
    </section>

    <!-- MODO DE PREPARO -->
    <section class="preparo">
      <h2>Modo de Preparo</h2>
      <ol id="modo-preparo">
        <% if (passos.length) { %>
          <% passos.forEach(function(step) { %>
            <li><%= step %></li>
          <% }) %>
        <% } %>
      </ol>
    </section>

    <!-- DICA DO CHEF -->
    <section class="dica-chef">
      <h2>Dica do Chef</h2>
      <p id="dica-chef"><%= recipe.tip || '' %></p>
    </section>

    <!-- COMENT츼RIOS -->
    <section class="comentarios">
      <h2>Coment치rios</h2>

      <form id="form-comentario">
        <textarea
          id="comentario-texto"
          rows="3"
          placeholder="Escreva um coment치rio..."
          required
        ></textarea>
        <button type="submit">Enviar coment치rio</button>
      </form>

      <ul id="lista-comentarios">
        <% comments.forEach(function(c) { %>
          <% const dataComentario = c.created_at ? new Date(c.created_at) : null; %>

          <li class="comentario-item"
              data-comment-id="<%= c.id %>"
              data-comment-user-id="<%= c.user_id %>">

            <div class="comentario-conteudo">
              <div class="comentario-topo">
                <strong><%= c.author_name %></strong>
                <span class="comentario-data">
                  <%= dataComentario ? dataComentario.toLocaleDateString('pt-BR') : '' %>
                </span>
              </div>

              <p class="comentario-texto"><%= c.content %></p>
            </div>

            <div class="comentario-acoes">
              <button type="button" class="btn-editar-comentario">Editar</button>
              <button type="button" class="btn-excluir-comentario">Excluir</button>
            </div>
          </li>
        <% }) %>
      </ul>
    </section>
  </main>

  <%- include('partials/_footer') %>

  <script src="/js/categorias.js"></script>
  <script src="/js/navbar.js"></script>
  <script src="/js/receita.js" defer></script>
</body>
</html>
