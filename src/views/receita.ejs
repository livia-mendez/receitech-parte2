<%- include('partials/_head') %>

<link rel="stylesheet" href="/css/receita.css">
<link rel="stylesheet" href="/css/navbar.css">
<link rel="stylesheet" href="/css/footer.css">

<body>
  <!-- BOT√ÉO VOLTAR -->
  <div class="voltar-container">
    <button class="voltar" onclick="window.history.back()" aria-label="Voltar">
      <img src="/assets/setinha-cinza.svg" alt="Voltar" width="25" height="25">
    </button>
  </div>

  <!-- NAVBAR -->
  <%- include('partials/_navbar') %>

  <main class="container-receita" style="position:relative;">

    <h1 id="nome-receita"><%= recipe.title %></h1>

    <!-- üî• BLOCO DE A√á√ïES DA RECEITA (S√ì APARECE PRO AUTOR VIA JS) -->
    <div
      class="receita-acoes"
      data-recipe-id="<%= recipe.id %>"
      data-author-id="<%= recipe.user_id %>"
      style="display: none;"
    >
      <button
        type="button"
        class="btn-acao-receita btn-editar-receita"
        aria-label="Editar receita"
      >
        <img src="/assets/icon-editar.png" alt="Editar receita">
      </button>

      <button
        type="button"
        class="btn-acao-receita btn-excluir-receita"
        aria-label="Excluir receita"
      >
        <img src="/assets/icon-excluir.png" alt="Excluir receita">
      </button>
    </div>

    <div class="imagem-central">
      <img
        id="imagem-receita"
        src="<%= recipe.cover_image || '/assets/imagem-padrao.png' %>"
        alt="<%= recipe.title %>"
      >
    </div>

    <div class="detalhes-receita">
      <a href="/perfil" aria-label="Perfil">
        <img
          id="avatar-autor"
          src="/assets/icon-perfil.svg"
          alt="Usu√°rio"
        >
      </a>

      <span id="autor-receita">
        <%= recipe.author_name || 'Autor desconhecido' %>
      </span>

      <img src="/assets/icon-tempo.svg" alt="Rel√≥gio">
      <span id="tempo-preparo">
        <%= recipe.prep_time_min || '‚Äî' %>
      </span>
    </div>

    <% 
      // ------- NORMALIZA INGREDIENTES -------
      let ingredientes = [];
      if (Array.isArray(recipe.ingredients)) {
        ingredientes = recipe.ingredients;
      } else if (typeof recipe.ingredients === 'string' && recipe.ingredients.trim()) {
        try {
          const parsed = JSON.parse(recipe.ingredients);
          if (Array.isArray(parsed)) {
            ingredientes = parsed;
          } else {
            ingredientes = [recipe.ingredients];
          }
        } catch (e) {
          ingredientes = [recipe.ingredients];
        }
      }

      // ------- NORMALIZA PASSOS -------
      let passos = [];
      if (Array.isArray(recipe.steps)) {
        passos = recipe.steps;
      } else if (typeof recipe.steps === 'string' && recipe.steps.trim()) {
        try {
          const parsedSteps = JSON.parse(recipe.steps);
          if (Array.isArray(parsedSteps)) {
            passos = parsedSteps;
          } else {
            passos = [recipe.steps];
          }
        } catch (e) {
          passos = [recipe.steps];
        }
      }
    %>

    <section class="sobre">
      <h2>Sobre a Receita</h2>
      <p id="sobre-receita"><%= recipe.description || '' %></p>
    </section>

    <section class="ingredientes">
      <h2>Ingredientes</h2>
      <ul id="ingredientes">
        <% if (ingredientes && ingredientes.length) { %>
          <% ingredientes.forEach(function(ing, index) { %>
            <li><%= ing %></li>
          <% }) %>
        <% } %>
      </ul>
    </section>

    <section class="preparo">
      <h2>Modo de Preparo</h2>
      <ol id="modo-preparo">
        <% if (passos && passos.length) { %>
          <% passos.forEach(function(step, index) { %>
            <li><%= step %></li>
          <% }) %>
        <% } %>
      </ol>
    </section>

    <section class="dica-chef">
      <h2>Dica do Chef</h2>
      <p id="dica-chef"><%= recipe.tip || '' %></p>
    </section>

    <section class="comentarios">
      <h2>Coment√°rios</h2>

      <form id="form-comentario">
        <textarea
          id="comentario-texto"
          rows="3"
          placeholder="Escreva um coment√°rio..."
          required
        ></textarea>
        <button type="submit">Enviar coment√°rio</button>
      </form>

      <ul id="lista-comentarios">
        <% comments.forEach(function(c) { %>
          <% const dataComentario = c.created_at ? new Date(c.created_at) : null; %>

          <li class="comentario-item"
              data-comment-id="<%= c.id %>"
              data-comment-user-id="<%= c.user_id %>">

            <!-- CARD BRANCO DO COMENT√ÅRIO -->
            <div class="comentario-conteudo">
              <div class="comentario-topo">
                <strong><%= c.author_name %></strong>
                <span class="comentario-data">
                  <%= dataComentario ? dataComentario.toLocaleDateString('pt-BR') : '' %>
                </span>
              </div>

              <p class="comentario-texto"><%= c.content %></p>
            </div>

            <!-- BOT√ïES FORA DO CARD, MAS DENTRO DO MESMO <li> -->
            <div class="comentario-acoes">
              <button type="button" class="btn-editar-comentario">Editar</button>
              <button type="button" class="btn-excluir-comentario">Excluir</button>
            </div>
          </li>
        <% }) %>
      </ul>
    </section>
  </main>

  <%- include('partials/_footer') %>

  <script src="/js/categorias.js"></script>
  <script src="/js/navbar.js"></script>
  <script src="/js/receita.js" defer></script>
</body>
</html>
